<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Level 1: The Earth</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(135deg, #0c0c1e 0%, #1a1a2e 25%, #16213e 50%, #0f3460 75%, #533483 100%);
            overflow: hidden;
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            position: relative;
        }

        /* Animated stars background */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(2px 2px at 20px 30px, #eee, transparent),
                radial-gradient(2px 2px at 40px 70px, rgba(255,255,255,0.8), transparent),
                radial-gradient(1px 1px at 90px 40px, #fff, transparent),
                radial-gradient(1px 1px at 130px 80px, rgba(255,255,255,0.6), transparent),
                radial-gradient(2px 2px at 160px 30px, #fff, transparent);
            background-repeat: repeat;
            background-size: 200px 100px;
            animation: sparkle 20s linear infinite;
            z-index: 1;
        }

        @keyframes sparkle {
            from { transform: translateX(0); }
            to { transform: translateX(-200px); }
        }

        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            border: none;
            border-radius: 0;
            box-shadow: none;
            z-index: 2;
        }

        .game-title {
            position: absolute;
            top: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: #ffffff;
            font-family: 'Orbitron', 'Courier New', monospace;
            font-size: 48px;
            font-weight: 900;
            letter-spacing: 4px;
            text-transform: uppercase;
            text-shadow: 
                0 0 5px rgba(79, 172, 254, 0.8),
                0 0 10px rgba(79, 172, 254, 0.6),
                0 0 20px rgba(79, 172, 254, 0.4),
                0 0 40px rgba(79, 172, 254, 0.2);
            background: linear-gradient(45deg, #4facfe, #00f2fe, #ffffff, #4facfe);
            background-size: 400% 400%;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: titleGlow 3s ease-in-out infinite;
            z-index: 10;
        }

        @keyframes titleGlow {
            0%, 100% { 
                background-position: 0% 50%;
                text-shadow: 
                    0 0 5px rgba(79, 172, 254, 0.8),
                    0 0 10px rgba(79, 172, 254, 0.6),
                    0 0 20px rgba(79, 172, 254, 0.4);
            }
            50% { 
                background-position: 100% 50%;
                text-shadow: 
                    0 0 10px rgba(0, 242, 254, 0.9),
                    0 0 20px rgba(0, 242, 254, 0.7),
                    0 0 30px rgba(0, 242, 254, 0.5),
                    0 0 40px rgba(0, 242, 254, 0.3);
            }
        }

        .controls {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: #cbd5e1;
            font-family: 'Orbitron', monospace;
            font-size: 12px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 1px;
            z-index: 10;
        }

        .logout-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
            color: #ef4444;
            border: 2px solid rgba(239, 68, 68, 0.6);
            padding: 10px 20px;
            border-radius: 10px;
            text-decoration: none;
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.2);
            z-index: 10;
        }

        .logout-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        /* 2D Game UI Overlay */
        #gameUI {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }


        #notifications {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 10px 20px;
            color: white;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        #earthTooltip {
            position: absolute;
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.95), rgba(147, 51, 234, 0.95));
            color: white;
            font-family: 'Orbitron', monospace;
            font-size: 14px;
            font-weight: 600;
            border: 2px solid rgba(79, 172, 254, 0.8);
            border-radius: 12px;
            padding: 15px;
            padding-top: 35px;
            box-shadow: 0 0 20px rgba(79, 172, 254, 0.5);
            backdrop-filter: blur(10px);
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: auto;
            z-index: 100;
            min-width: 300px;
            max-width: 400px;
        }
        
        .close-btn {
            position: absolute;
            top: 8px;
            right: 12px;
            background: rgba(239, 68, 68, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .close-btn:hover {
            background: rgba(239, 68, 68, 1);
            transform: scale(1.1);
        }
        
        .quiz-question {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #4facfe;
        }
        
        .quiz-answers {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .quiz-answers li {
            padding: 8px 0;
            font-size: 13px;
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }
        
        .quiz-answers input[type="checkbox"] {
            margin-right: 10px;
            width: 16px;
            height: 16px;
            accent-color: #4facfe;
            cursor: pointer;
        }
        
        .quiz-answers label {
            cursor: pointer;
            flex: 1;
            color: #ffffff;
        }
        
        .submit-btn {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.8), rgba(147, 51, 234, 0.8));
            color: white;
            border: 2px solid rgba(79, 172, 254, 0.6);
            padding: 10px 20px;
            border-radius: 8px;
            font-family: 'Orbitron', monospace;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.3s ease;
            width: 100%;
        }
        
        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }
        
        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .game-stats {
            position: absolute;
            top: 100px;
            left: 20px;
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.15), rgba(147, 51, 234, 0.15));
            border: 2px solid rgba(79, 172, 254, 0.4);
            border-radius: 12px;
            padding: 15px;
            color: white;
            font-family: 'Orbitron', monospace;
            font-size: 12px;
            font-weight: 600;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 15px rgba(79, 172, 254, 0.3);
            z-index: 10;
            min-width: 200px;
        }
        
        .stat-item {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .potential-score {
            font-size: 10px;
            color: #fbbf24;
            margin-left: 5px;
        }
        
        .stat-label {
            color: #4facfe;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .stat-value {
            color: #ffffff;
            font-weight: 700;
        }
        
        .difficulty-badge {
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .difficulty-easy {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        
        .difficulty-medium {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        
        .difficulty-hard {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 10px rgba(79, 172, 254, 0.5); }
            50% { box-shadow: 0 0 30px rgba(79, 172, 254, 0.8); }
            100% { box-shadow: 0 0 10px rgba(79, 172, 254, 0.5); }
        }
    </style>
</head>
<body>
    <div class="game-title">Level 1: The Earth</div>
    <a href="/logout" class="logout-btn">Logout</a>
    <div class="controls">Press ESC to return to main page | Mouse to rotate view | Click to interact</div>
    
    <!-- Game Statistics -->
    <div class="game-stats">
        <div class="stat-item">
            <span class="stat-label">Score:</span>
            <span class="stat-value">
                <span id="scoreValue">0</span>
                <span class="potential-score" id="potentialScore">(+100)</span>
            </span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Difficulty:</span>
            <span class="stat-value">
                <span class="difficulty-badge difficulty-easy" id="difficultyBadge">Easy</span>
            </span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Streak:</span>
            <span class="stat-value" id="progressValue">0/3</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Questions:</span>
            <span class="stat-value" id="questionCount">1</span>
        </div>
    </div>
    
    <!-- Simple UI Overlay -->
    <div id="gameUI">
        <!-- Notification Area -->
        <div id="notifications"></div>
        <!-- Earth Hover Tooltip -->
        <div id="earthTooltip">
            <button class="close-btn" onclick="closeTooltip()">√ó</button>
            <div class="quiz-question" id="questionText">üåç What is Earth's position from the Sun?</div>
            <form id="quizForm">
                <ul class="quiz-answers" id="answersList">
                    <li>
                        <input type="checkbox" id="answer-a" name="answer" value="a">
                        <label for="answer-a">A) First planet</label>
                    </li>
                    <li>
                        <input type="checkbox" id="answer-b" name="answer" value="b">
                        <label for="answer-b">B) Second planet</label>
                    </li>
                    <li>
                        <input type="checkbox" id="answer-c" name="answer" value="c">
                        <label for="answer-c">C) Third planet</label>
                    </li>
                    <li>
                        <input type="checkbox" id="answer-d" name="answer" value="d">
                        <label for="answer-d">D) Fourth planet</label>
                    </li>
                </ul>
                <button type="button" class="submit-btn" onclick="submitAnswer()" id="submitBtn">Submit Answer</button>
            </form>
        </div>
    </div>
    
    <canvas id="gameCanvas" width="1920" height="1080"></canvas>

    <script>
        // Game state
        let gameState = {
            earthRotation: 0,
            score: 0,
            difficulty: 'easy', // easy, medium, hard
            correctAnswersInLevel: 0,
            totalQuestions: 0,
            currentQuestionIndex: 0,
            usedQuestions: { easy: [], medium: [], hard: [] }, // Track used questions
            currentQuestionPotentialScore: 0, // Full points available for current question
            wrongAnswerCount: 0, // Track wrong answers for current question
            currentQuestion: null // Store the current question being displayed
        };
        
        // Question bank with engaging astronomy and Earth science questions
        const questionBank = {
            easy: [
                {
                    question: "üåç If you could drill straight through Earth's center, which layer would be the hottest obstacle?",
                    answers: ["The mantle", "The outer core", "The inner core", "The crust"],
                    correct: 2,
                    explanation: "The inner core reaches temperatures of 5,000-6,000¬∞C, hotter than the Sun's surface!"
                },
                {
                    question: "üåô Why does the Moon appear the same size as the Sun during a solar eclipse?",
                    answers: ["They are the same size", "It's an incredible cosmic coincidence", "The atmosphere magnifies the Moon", "Earth's gravity bends light"],
                    correct: 1,
                    explanation: "The Sun is 400x larger than the Moon, but also 400x farther away - pure cosmic luck!"
                },
                {
                    question: "üåä What would happen to Earth's oceans if the Moon suddenly disappeared?",
                    answers: ["Nothing significant", "Tides would become much smaller", "The oceans would freeze", "Water would float into space"],
                    correct: 1,
                    explanation: "Without the Moon's gravitational pull, tides would be only about 1/3 their current size."
                },
                {
                    question: "‚ö° Earth's magnetic field occasionally flips. When did this last happen?",
                    answers: ["780,000 years ago", "12,000 years ago", "2,000 years ago", "It's never happened"],
                    correct: 0,
                    explanation: "The Brunhes-Matuyama reversal was the last major magnetic pole flip, and we're overdue for another!"
                },
                {
                    question: "üåç If Earth stopped rotating but kept orbiting the Sun, how long would a day last?",
                    answers: ["24 hours", "365 days", "12 hours", "There would be no day/night cycle"],
                    correct: 1,
                    explanation: "One side would face the Sun for half the year, then the other side - each 'day' would be a full year!"
                },
                {
                    question: "üî• What creates the beautiful aurora (Northern/Southern Lights) in Earth's atmosphere?",
                    answers: ["Sunlight reflecting off ice crystals", "Solar wind particles hitting our magnetic field", "Lightning in the upper atmosphere", "Volcanic ash glowing in space"],
                    correct: 1,
                    explanation: "Charged particles from the Sun collide with our magnetosphere, creating these stunning light displays!"
                },
                {
                    question: "üåç Why is Earth the only planet in our solar system with liquid water oceans?",
                    answers: ["We have the most water", "We're in the 'Goldilocks Zone'", "Our atmosphere is thickest", "We have the strongest gravity"],
                    correct: 1,
                    explanation: "Earth orbits at just the right distance - not too hot, not too cold - for liquid water to exist!"
                }
            ],
            medium: [
                {
                    question: "üåç Earth's axis wobbles like a spinning top. This 26,000-year cycle affects what?",
                    answers: ["The length of seasons", "Which star is our 'North Star'", "The strength of gravity", "Ocean currents"],
                    correct: 1,
                    explanation: "Axial precession means Polaris won't always be our North Star - in 12,000 years, Vega will be!"
                },
                {
                    question: "üåä The deepest point in Earth's oceans is the Challenger Deep. How deep is it?",
                    answers: ["8,848 meters", "11,034 meters", "6,960 meters", "15,200 meters"],
                    correct: 1,
                    explanation: "The Challenger Deep in the Mariana Trench is 11,034m deep - deeper than Mount Everest is tall!"
                },
                {
                    question: "üî¨ What percentage of Earth's habitable space is in the deep ocean?",
                    answers: ["20%", "50%", "80%", "95%"],
                    correct: 3,
                    explanation: "About 95% of Earth's habitable space is in the deep ocean - the vast majority of our biosphere!"
                },
                {
                    question: "‚≠ê From space, what human-made structure is most easily visible on Earth?",
                    answers: ["The Great Wall of China", "City lights at night", "Large airports", "The pyramids"],
                    correct: 1,
                    explanation: "Contrary to myth, the Great Wall isn't visible from space, but city lights create a brilliant glow!"
                },
                {
                    question: "üåç Earth's core generates our magnetic field. What metal makes up most of this core?",
                    answers: ["Nickel", "Iron", "Copper", "Gold"],
                    correct: 1,
                    explanation: "Earth's core is mostly molten iron, creating electrical currents that generate our protective magnetic field!"
                },
                {
                    question: "üåã The 'Ring of Fire' around the Pacific contains what percentage of Earth's active volcanoes?",
                    answers: ["50%", "60%", "75%", "90%"],
                    correct: 2,
                    explanation: "This horseshoe-shaped zone has 75% of the world's volcanoes due to tectonic plate boundaries!"
                },
                {
                    question: "üåô Earth's Moon is gradually moving away from us. How much farther each year?",
                    answers: ["3.8 centimeters", "1.2 meters", "5 millimeters", "It's getting closer"],
                    correct: 0,
                    explanation: "The Moon drifts away at 3.8cm per year due to tidal forces - days are getting longer too!"
                }
            ],
            hard: [
                {
                    question: "üåç Earth's rotation is slowing down due to tidal friction. How much longer is each day getting per century?",
                    answers: ["1.7 milliseconds", "5.2 milliseconds", "12.8 milliseconds", "25.6 milliseconds"],
                    correct: 0,
                    explanation: "Each day gets about 1.7 milliseconds longer per century due to tidal friction from the Moon!"
                },
                {
                    question: "‚ö° Earth's magnetosphere deflects solar wind. Without it, what would happen to our atmosphere?",
                    answers: ["Nothing would change", "It would slowly be stripped away like Mars", "It would become thicker", "It would turn into plasma"],
                    correct: 1,
                    explanation: "Mars lost most of its atmosphere this way - our magnetic field is crucial for keeping our air!"
                },
                {
                    question: "üåä The Coriolis effect influences ocean currents. What causes this phenomenon?",
                    answers: ["Earth's magnetic field", "Earth's rotation", "The Moon's gravity", "Solar radiation pressure"],
                    correct: 1,
                    explanation: "Earth's rotation creates apparent forces that deflect moving objects, driving global circulation patterns!"
                },
                {
                    question: "üî• Earth's inner core is solid despite being hotter than the outer core. Why?",
                    answers: ["It's made of different materials", "Extreme pressure keeps it solid", "It's actually cooler", "Magnetic fields compress it"],
                    correct: 1,
                    explanation: "Immense pressure at Earth's center forces iron into a solid state despite temperatures of 6,000¬∞C!"
                },
                {
                    question: "üåç Earth wobbles on its axis due to mass redistribution. What recent event affects this wobble?",
                    answers: ["Melting polar ice", "Volcanic eruptions", "Ocean currents", "All of the above"],
                    correct: 3,
                    explanation: "Climate change, earthquakes, and even large dams can shift Earth's mass and affect its rotation!"
                },
                {
                    question: "‚≠ê Earth occasionally captures small asteroids as temporary moons. How long do they typically stay?",
                    answers: ["A few days", "Several months", "A few years", "They never leave"],
                    correct: 1,
                    explanation: "These 'minimoons' orbit Earth for months before escaping - we've detected several!"
                },
                {
                    question: "üåä What is the approximate concentration of gold in Earth's oceans?",
                    answers: ["0.004 parts per billion", "0.4 parts per billion", "4 parts per billion", "40 parts per billion"],
                    correct: 2,
                    explanation: "There's about 4 parts per billion of gold in seawater - totaling roughly 20 million tons, but too dilute to extract!"
                }
            ]
        };

        // Canvas setup
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Constants (converted from Pygame)
        const SCREEN_WIDTH = 1920;
        const SCREEN_HEIGHT = 1080;
        const EARTH_RADIUS = 200;
        const EARTH_CENTER = { x: SCREEN_WIDTH / 2, y: SCREEN_HEIGHT / 2 };
        
        // Adjust canvas size to actual viewport
        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            // Update Earth center based on actual canvas size
            EARTH_CENTER.x = canvas.width / 2;
            EARTH_CENTER.y = canvas.height / 2;
        }
        
        // Initial resize
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // Colors
        const BLACK = '#000000';
        const DEEP_BLUE = '#003264';
        const OCEAN_BLUE = '#1E90FF';
        const LAND_GREEN = '#228B22';
        const LAND_BROWN = '#8B4513';
        const CLOUD_WHITE = 'rgba(255, 255, 255, 0.6)';
        const ATMOSPHERE_BLUE = 'rgba(135, 206, 250, 0.3)';

        // Generate stars
        const stars = [];
        for (let i = 0; i < 200; i++) {
            stars.push({
                x: Math.random() * SCREEN_WIDTH,
                y: Math.random() * SCREEN_HEIGHT,
                brightness: Math.random() * 155 + 100,
                size: Math.random() < 0.8 ? 1 : 2
            });
        }

        // Draw functions (converted from Pygame)
        function drawStars() {
            stars.forEach(star => {
                const twinkle = Math.random() * 60 - 30;
                const brightness = Math.max(50, Math.min(255, star.brightness + twinkle));
                const gray = Math.floor(brightness);
                
                ctx.fillStyle = `rgb(${gray}, ${gray}, ${gray})`;
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.size, 0, Math.PI * 2);
                ctx.fill();
            });
        }

        // Load and draw Earth texture image
        const earthImage = new Image();
        earthImage.src = '/static/earth_texture.jpg';
        
        // Add error handling and loading check
        earthImage.onerror = function() {
            console.log('Failed to load earth_texture.jpg, trying Earth.png');
            earthImage.src = '/static/Earth.png';
        };
        
        earthImage.onload = function() {
            console.log('Earth image loaded successfully');
        };
        
        function drawEarthTexture() {
            if (earthImage.complete) {
                // Create circular clipping path
                ctx.save();
                ctx.beginPath();
                ctx.arc(EARTH_CENTER.x, EARTH_CENTER.y, EARTH_RADIUS, 0, Math.PI * 2);
                ctx.clip();
                
                // Draw the Earth texture image
                ctx.drawImage(
                    earthImage,
                    EARTH_CENTER.x - EARTH_RADIUS,
                    EARTH_CENTER.y - EARTH_RADIUS,
                    EARTH_RADIUS * 2,
                    EARTH_RADIUS * 2
                );
                
                ctx.restore();
            } else {
                // Fallback to simple blue circle if image not loaded
                ctx.fillStyle = OCEAN_BLUE;
                ctx.beginPath();
                ctx.arc(EARTH_CENTER.x, EARTH_CENTER.y, EARTH_RADIUS, 0, Math.PI * 2);
                ctx.fill();
            }
        }




        function showNotification(message, duration = 3000) {
            const notifications = document.getElementById('notifications');
            notifications.textContent = message;
            notifications.style.opacity = '1';
            setTimeout(() => {
                notifications.style.opacity = '0';
            }, duration);
        }



        // Mouse tracking for Earth hover
        let mouseX = 0;
        let mouseY = 0;
        let isHoveringEarth = false;
        
        canvas.addEventListener('mousemove', (event) => {
            const rect = canvas.getBoundingClientRect();
            mouseX = event.clientX - rect.left;
            mouseY = event.clientY - rect.top;
            
            // Check if mouse is over Earth
            const dx = mouseX - EARTH_CENTER.x;
            const dy = mouseY - EARTH_CENTER.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            
            const tooltip = document.getElementById('earthTooltip');
            
            console.log('Mouse position:', mouseX, mouseY, 'Earth center:', EARTH_CENTER.x, EARTH_CENTER.y, 'Distance:', distance, 'Radius:', EARTH_RADIUS);
            
            if (distance <= EARTH_RADIUS) {
                if (!isHoveringEarth) {
                    isHoveringEarth = true;
                    tooltip.style.opacity = '1';
                    console.log('Showing tooltip');
                    
                    // Position tooltip near Earth but not covering it
                    tooltip.style.left = (EARTH_CENTER.x + EARTH_RADIUS + 20) + 'px';
                    tooltip.style.top = (EARTH_CENTER.y - 60) + 'px';
                }
            } else {
                // Only auto-hide if tooltip was triggered by hover (not manually opened)
                if (isHoveringEarth && tooltip.style.opacity === '1') {
                    // Don't auto-hide anymore - let user close manually
                }
            }
        });
        
        // Function to close tooltip
        function closeTooltip() {
            const tooltip = document.getElementById('earthTooltip');
            tooltip.style.opacity = '0';
            isHoveringEarth = false;
            // Reset form when closing
            document.getElementById('quizForm').reset();
        }
        
        // Initialize game when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            loadQuestion();
            updateGameStats();
            attachCheckboxListeners();
        });
        
        // Get current question based on difficulty and progress (no repeats)
        function getCurrentQuestion() {
            const questions = questionBank[gameState.difficulty];
            const usedQuestions = gameState.usedQuestions[gameState.difficulty];
            
            // Find unused questions
            const availableQuestions = questions.filter((_, index) => !usedQuestions.includes(index));
            
            // If all questions used, reset the used list (but this shouldn't happen with progression)
            if (availableQuestions.length === 0) {
                gameState.usedQuestions[gameState.difficulty] = [];
                return questions[0];
            }
            
            // Get random unused question
            const randomIndex = Math.floor(Math.random() * availableQuestions.length);
            const selectedQuestion = availableQuestions[randomIndex];
            
            // Mark this question as used
            const originalIndex = questions.indexOf(selectedQuestion);
            gameState.usedQuestions[gameState.difficulty].push(originalIndex);
            
            return selectedQuestion;
        }
        
        // Load and display current question
        function loadQuestion() {
            const question = getCurrentQuestion();
            gameState.currentQuestion = question; // Store the current question
            const questionText = document.getElementById('questionText');
            const answersList = document.getElementById('answersList');
            
            questionText.textContent = question.question;
            
            // Reset question-specific state
            gameState.wrongAnswerCount = 0;
            
            // Set potential score based on difficulty
            switch (gameState.difficulty) {
                case 'easy': gameState.currentQuestionPotentialScore = 100; break;
                case 'medium': gameState.currentQuestionPotentialScore = 200; break;
                case 'hard': gameState.currentQuestionPotentialScore = 300; break;
            }
            
            // Clear existing answers
            answersList.innerHTML = '';
            
            // Add new answers
            question.answers.forEach((answer, index) => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <input type="checkbox" id="answer-${String.fromCharCode(97 + index)}" name="answer" value="${index}">
                    <label for="answer-${String.fromCharCode(97 + index)}">${String.fromCharCode(65 + index)}) ${answer}</label>
                `;
                answersList.appendChild(li);
            });
            
            // Re-attach checkbox event listeners
            attachCheckboxListeners();
            
            // Update question counter and potential score display
            document.getElementById('questionCount').textContent = gameState.totalQuestions + 1;
            updatePotentialScoreDisplay();
        }
        
        // Update game statistics display
        function updateGameStats() {
            document.getElementById('scoreValue').textContent = gameState.score;
            document.getElementById('progressValue').textContent = `${gameState.correctAnswersInLevel}/3`;
            
            const difficultyBadge = document.getElementById('difficultyBadge');
            difficultyBadge.textContent = gameState.difficulty.charAt(0).toUpperCase() + gameState.difficulty.slice(1);
            difficultyBadge.className = `difficulty-badge difficulty-${gameState.difficulty}`;
            
            updatePotentialScoreDisplay();
        }
        
        // Update potential score display
        function updatePotentialScoreDisplay() {
            const potentialScoreElement = document.getElementById('potentialScore');
            potentialScoreElement.textContent = `(+${gameState.currentQuestionPotentialScore})`;
        }
        
        // Save score to database
        async function saveScoreToDatabase() {
            try {
                const response = await fetch('/save_score', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        score: gameState.score,
                        level: 1 // Earth level
                    })
                });
                
                const result = await response.json();
                if (result.success && result.new_high_score) {
                    showNotification('üéâ New High Score! Score saved to your profile!', 3000);
                }
            } catch (error) {
                console.error('Failed to save score:', error);
            }
        }
        
        // Handle difficulty progression
        function checkDifficultyProgression() {
            if (gameState.correctAnswersInLevel >= 3) {
                if (gameState.difficulty === 'easy') {
                    gameState.difficulty = 'medium';
                    gameState.correctAnswersInLevel = 0;
                    gameState.currentQuestionIndex = 0;
                    showNotification('üéâ Perfect streak! Difficulty increased to Medium! Questions now worth 200 points!', 4000);
                } else if (gameState.difficulty === 'medium') {
                    gameState.difficulty = 'hard';
                    gameState.correctAnswersInLevel = 0;
                    gameState.currentQuestionIndex = 0;
                    showNotification('üî• Excellent! Difficulty increased to Hard! Questions now worth 300 points!', 4000);
                } else if (gameState.difficulty === 'hard') {
                    // Completed all difficulties - ready for next level
                    showNotification('üöÄ Outstanding! You\'ve mastered Earth with perfect streaks! Ready for the Solar System level!', 6000);
                    // Save final score
                    saveScoreToDatabase();
                    // TODO: Implement transition to Solar System level
                    return;
                }
                updateGameStats();
            }
        }
        
        // Submit answer function
        function submitAnswer() {
            const checkboxes = document.querySelectorAll('input[name="answer"]');
            const selectedAnswer = Array.from(checkboxes).find(cb => cb.checked);
            
            if (!selectedAnswer) {
                showNotification('Please select an answer first!', 2000);
                return;
            }
            
            // Use the stored current question instead of calling getCurrentQuestion() again
            const question = gameState.currentQuestion;
            const selectedIndex = parseInt(selectedAnswer.value);
            const isCorrect = selectedIndex === question.correct;
            
            gameState.totalQuestions++;
            
            if (isCorrect) {
                // Award the current potential score
                const points = gameState.currentQuestionPotentialScore;
                
                gameState.score += points;
                gameState.correctAnswersInLevel++;
                gameState.currentQuestionIndex++;
                
                showNotification(`üéâ Correct! +${points} points! Score: ${gameState.score} | Streak: ${gameState.correctAnswersInLevel}/3`, 3000);
                
                // Save score to database
                saveScoreToDatabase();
                
                // Check for difficulty progression
                setTimeout(() => {
                    checkDifficultyProgression();
                }, 1000);
                
                // Load next question after a delay
                setTimeout(() => {
                    loadQuestion();
                    updateGameStats();
                }, 2000);
            } else {
                // Reset progress when user makes a mistake
                gameState.correctAnswersInLevel = 0;
                
                // Reduce potential score by 1/5 for wrong answer
                gameState.wrongAnswerCount++;
                gameState.currentQuestionPotentialScore = Math.max(1, Math.floor(gameState.currentQuestionPotentialScore * 0.8));
                
                showNotification(`‚ùå Wrong answer! Progress reset. The correct answer was: ${question.answers[question.correct]}. ${question.explanation || ''} You need 3 consecutive correct answers to advance.`, 8000);
                
                // Update potential score display
                updatePotentialScoreDisplay();
                
                // Stay on same question - no progression on wrong answers
            }
            
            // Reset form after submission
            setTimeout(() => {
                document.getElementById('quizForm').reset();
            }, 500);
            
            updateGameStats();
        }
        
        // Attach checkbox event listeners
        function attachCheckboxListeners() {
            const checkboxes = document.querySelectorAll('input[name="answer"]');
            
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        // Uncheck all other checkboxes
                        checkboxes.forEach(cb => {
                            if (cb !== this) {
                                cb.checked = false;
                            }
                        });
                    }
                });
            });
        }
        
        // Remove auto-hide on mouse leave - tooltip now persists
        canvas.addEventListener('mouseleave', () => {
            // Tooltip no longer auto-hides
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                window.location.href = '/';
            }
        });

        // Main game loop
        function gameLoop() {
            // Clear screen
            ctx.fillStyle = BLACK;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw stars
            drawStars();
            
            // Draw static Earth texture
            drawEarthTexture();
            
            // Continue animation
            requestAnimationFrame(gameLoop);
        }

        // Start the game
        gameLoop();
    </script>
</body>
</html>
